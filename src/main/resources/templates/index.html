<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Mshare  source</title>
    <link rel="stylesheet" media="all" type="text/css" th:href="@{/bootstrap/css/bootstrap.min.css}" href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css"/>
    <link rel="stylesheet" media="all" type="text/css" th:href="@{/css/mdb.min.css}" href="/css/mdb.min.css"/>
    <link rel="stylesheet" media="all" type="text/css" th:href="@{/css/index.css}" href="/css/index.css"/>
</head>
<body>
    <div class="container-fluid">
        <!--Navbar -->
        <nav class="mb-1 navbar navbar-expand-lg navbar-dark default-color">
            <a class="navbar-brand" href="#">Mshare source</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent-333"
                    aria-controls="navbarSupportedContent-333" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent-333">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Trang chủ
                            <span class="sr-only">(current)</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Hỏi đáp</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Giới thiệu</a>
                    </li>
                </ul>
                <ul class="navbar-nav ml-auto nav-flex-icons">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdownMenuLink-333" data-toggle="dropdown"
                           aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-user"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right dropdown-default"
                             aria-labelledby="navbarDropdownMenuLink-333">
                            <a class="dropdown-item" href="#">Đăng nhập</a>
                            <a class="dropdown-item" href="#">Đăng ký</a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
        <!--/.Navbar -->

        <div class="row">
            <form id="form-upload-file">
                <input type="file" multiple id="inputListFile" name="fileUpload[]">
                <p>
                    Kéo thả file vào đây để upload
                </p>

                <ol id="list-file">
                </ol>

                <button type="button" id="btn-upload">Upload</button>
            </form>
        </div>
    </div>


    <script src="/jquery/jquery-3.4.1.min.js" th:src="@{/jquery/jquery-3.4.1.min.js}"></script>
    <script src="/js/popper.min.js" th:src="@{/js/popper.min.js}"></script>
    <script src="/bootstrap/js/bootstrap.min.js" th:src="@{/bootstrap/js/bootstrap.min.js}"></script>
    <script src="/js/mdb.min.js" th:src="@{/js/mdb.min.js}"></script>

    <script type="text/javascript">

        function sendUploadServer(urlUpload, file) {
            $.ajax({
                headers: {
                    "Content-Range": "bytes 0-31370/31371",
                    "Content-Type": file.type,
                    "X-Upload-Content-Length": file.size,
                    "X-Upload-Content-Type": file.type
                },
                method: "put",
                url: urlUpload,
                data: file,
                processData:false,
                success: function (result) {
                    console.log(result);
                },
                fail: function (error) {
                    console.log(error);
                }
            })
        }

        $(document).ready(function(){
            $('#form-upload-file #inputListFile').change(function () {
                $('#form-upload-file p').text(this.files.length + " file(s) selected");

                $('#list-file').empty();

                var i;
                for(i = 0; i < this.files.length; i++) {
                    var node = document.createElement("li");                 // Create a <li> node
                    var textnode = document.createTextNode(this.files.item(i).name);         // Create a text node
                    node.appendChild(textnode);                              // Append the text to <li>
                    $('#list-file').append(node);     // Append <li> to <ul> with id="myList"
                }
            });

            $('#btn-upload').click(function () {
               var listFile = document.getElementById('inputListFile').files;

               if (listFile.length > 5) {
                   alert('Chỉ được phép upload 5 file');
                   return;
               }
               var j;
               for(j = 0; j < listFile.length; j++) {
                   var fileItem = listFile.item(j);
                   var dataReq = {
                       "file_name" : fileItem.name,
                       "file_size" : fileItem.size,
                       "mime_type" : fileItem.type
                   };

                   $.ajax({
                       headers: {
                           "Content-Type": "application/json"
                       },
                       url: "http://localhost:8080/upload/check-hash",
                       type: "post",
                       dataType: "text",
                       data: JSON.stringify(dataReq)
                   }).done(function (result) {
                       var dataJs = JSON.parse(result);
                       var urlUpload = dataJs['url_upload'];
                       sendUploadServer(urlUpload, fileItem);
                   });
               }
            });

        });
    </script>
</body>
</html>